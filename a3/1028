# LDPlayer 관리자 ID 확인 및 IRIS 등록 절차 (2025-10-28)

## 1. 사전 준비
- LDPlayer에서 관리자 계정으로 카카오톡에 로그인하고, 테스트용 오픈채팅방에 접속해 둔다.
- `C:\dev\14.kakao` 저장소에서 Python 가상환경(`.venv`)이 활성화 가능한 상태인지 확인한다.
- IRIS 서버용 가상환경(`C:\dev\14.kakao\iris_server\venv`)도 이미 생성되어 있어야 한다.

## 2. 관리자 ID 수집: 이벤트 로그 방식
1. LDPlayer에서 관리자로 등록할 계정으로 대상 오픈채팅방에 텍스트 메시지를 1회 이상 전송한다.
2. Windows PowerShell을 열어 프로젝트 루트(`C:\dev\14.kakao`)로 이동한다.
3. 최신 로그 디렉터리를 확인한다.
   ```powershell
   Get-ChildItem -Path .\logs -Directory | Sort-Object LastWriteTime -Descending | Select-Object -First 1
   ```
4. 방 ID 폴더(예: `logs\1234567890`) 아래에서 오늘 날짜의 로그 파일을 찾는다.
   ```powershell
   Get-ChildItem -Path .\logs\<roomId> -Filter "$(Get-Date -Format yyyy-MM-dd).log"
   ```
5. 로그 파일에서 방금 전송한 메시지 레코드를 찾는다. `sender_id`가 관리자 ID이다.
   ```powershell
   Select-String -Path .\logs\<roomId>\$(Get-Date -Format yyyy-MM-dd).log -Pattern '"sender_id"'
   ```
   출력 예시:
   ```json
   "sender_id": 2541936490,
   ```
   → 숫자 `2541936490`이 관리자 ID.

## 3. 관리자 ID 수집: SQLite 조회 방식 (대안)
1. 메시지가 기록된 후, 가상환경을 사용하여 sqlite3를 실행한다.
   ```powershell
   .\.venv\Scripts\Activate.ps1
   sqlite3 data/messages.db
   ```
2. 특정 사용자의 최근 메시지를 조회한다.
   ```sql
   SELECT user_id, message_type, content
   FROM messages
   ORDER BY timestamp DESC
   LIMIT 10;
   ```
3. 조회 결과에서 관리자 계정이 작성한 레코드의 `user_id` 값을 확인한다.
4. sqlite3를 종료한다(`.exit`).
5. 가상환경을 비활성화한다(`deactivate`).

## 4. IRIS 관리자 등록
1. IRIS 서버 디렉터리로 이동하고 가상환경을 활성화한다.
   ```powershell
   Set-Location C:\dev\14.kakao\iris_server
   .\venv\Scripts\Activate.ps1
   ```
2. 앞 단계에서 확인한 숫자 ID를 사용해 관리자를 추가한다.
   ```powershell
   iris admin add <숫자ID>
   ```
   예: `iris admin add 2541936490`
3. 등록 결과를 확인한다.
   ```powershell
   iris admin list
   ```
   목록에 방금 추가한 ID가 나타나야 한다.
4. 작업이 끝나면 가상환경을 종료한다(`deactivate`).

## 5. 이후 점검 항목
- LDPlayer가 꺼지면 ADB 연결이 끊어지므로, LDPlayer 실행 → `adb connect` → IRIS 봇 실행 순으로 절차를 유지한다.
- `config/local.env` 파일의 IRIS_URL·ADB 호스트·포트 값이 실제 환경과 일치하는지 수시로 확인한다.
- 민감 정보(쿠키, API 키)는 `.env`나 OS 사용자 환경 변수에만 저장하고 Git에 커밋하지 않는다.
- 관리자 ID가 변경되면 동일한 절차로 재등록하거나, 불필요한 ID는 `iris admin remove <숫자ID>`로 삭제한다.

