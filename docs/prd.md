# Product Requirements Document (PRD)

## 1. 배경
카카오톡 오픈채팅 다중 방을 관리하고, 명령어·환영 메시지·방송 기능을 안정적으로 제공할 자동화 솔루션이 필요하다. 기존 PC UIA 접근은 속도 및 신뢰성 한계로 폐기하고, 루팅 안드로이드 단말 + IRIS + Hyper-V 리눅스 봇 서버 조합을 채택한다.

## 2. 목표
- 다중 방 추적: 10개 이상의 오픈채팅방에서 메시지를 수집·분류·보관한다.
- 명령어 응답: `!` 접두어 명령어를 수 초 이내에 처리하고, 텍스트/이미지/외부 API 결과를 반환한다.
- 신규 입장 환영: 새 참여자가 확인되면 지정된 메시지와 안내 이미지를 발송한다.
- 방송 메시지: 전체 또는 선택된 방에 동일한 공지/콘텐츠를 일괄 발송한다.

## 3. 기능 요구사항 상세

### 3.1 다중 방 추적
**목적**
- 등록된 모든 오픈채팅방에서 메시지·참여 이벤트를 실시간에 가깝게 수집하고 저장한다.

**트리거 & 전제조건**
- IRIS WebSocket 스트림에서 `message`, `join`, `leave` 이벤트 수신.
- 루팅 단말에서 Iris 앱이 실행 중이며 대상 방이 등록되어 있음.
- `config/local.env`에 IRIS 인증 정보 및 방 메타 경로가 지정되어 있음.

**주요 단계**
1. `src/bot/main.py`에서 IRIS 이벤트 스트림 연결을 유지한다.
2. 이벤트 유형별로 `src/services/` 하위 모듈로 라우팅한다 (예: `services/message_store.py`).
3. 메시지/메타 데이터는 우선 로컬 파일 로그(`logs/<roomId>/YYYY-MM-DD.log`)에 적재하고, 향후 DB 연동 시 어댑터를 교체한다.
4. 참여자 변동 이벤트는 SSOT 및 운영 대시보드로 전달할 수 있도록 `docs/journal/`에 요약 로그를 남긴다.

**산출물 / 로그**
- `logs/` 이하 일자별 텍스트 로그.
- 이벤트 타임라인 JSON (`artifacts/headless/<timestamp>-<room>/timeline.json`).
- 실패 시 `artifacts/.../error.json`에 스택/재시도 기록.

**성공 기준**
- 이벤트 수신 후 2초 이내에 로그 파일에 기록된다.
- 누락률 0%: IRIS 전달 건수와 내부 저장 건수가 동일하다.
- 동일 메시지의 중복 저장률 1% 미만.

**실패 및 예외 대응**
- IRIS 연결 끊김 시 5초 간격, 최대 5회 재시도하고 SSOT 히스토리에 기록한다.
- 루팅 단말에서 Iris 프로세스가 중단되면 `iris_control (status|start)`로 재기동하고 Hyper-V VM 로그에 기록한다.
- 메시지 파싱 실패 시 원본 payload를 `logs/errors/`에 저장하고 재처리 큐에 적재한다.

**연관 컴포넌트**
- `src/bot/main.py`, `src/services/message_store.py` (신규), `scripts/manage_instances.ps1`, `docs/setup/iris-hyperv.md`.

### 3.2 환영 및 안내 메시지
**목적**
- 새로운 참여자가 입장할 때 환영 멘트와 안내 이미지를 자동 발송해 초기 안내 품질을 보장한다.

**트리거 & 전제조건**
- IRIS `join` 이벤트 수신.
- `config/templates/welcome/`에 텍스트, 이미지 템플릿 존재.
- 방별 환영 설정이 `config/rooms.json` (예정) 혹은 DB에 저장되어 있음.

**주요 단계**
1. `join` 이벤트 수신 시 방 ID를 기준으로 환영 템플릿을 로드한다.
2. 이미지가 필요한 경우 Iris 앱을 통해 해당 방 대화창에 `iris send image` API를 호출한다.
3. 환영 메시지 발송 후 성공 응답을 확인하고, `logs/<roomId>/welcome.log`에 결과를 기록한다.
4. 실패 시 3회 재시도하며, 계속 실패하면 운영 알림(슬랙/메일) 큐에 적재한다.

**산출물 / 로그**
- 환영 메시지 발송 내역 (`welcome.log`).
- 전송 이미지 파일 (`uploads/openchat-captures/<roomId>/welcome.png`).
- 실패 시 `artifacts/.../welcome-error.json`.

**성공 기준**
- 입장 이벤트 후 3초 이내 텍스트 메시지 발송, 5초 이내 이미지 발송.
- 재시도 없이 단건 성공률 95% 이상.
- 동일 사용자에게 중복 환영 메시지 발송 금지.

**실패 및 예외 대응**
- 방이 잠금 상태이거나 이미지 업로드 실패 시 텍스트만 발송하고 경고 로그를 남긴다.
- 템플릿 누락 시 기본 템플릿(`config/templates/welcome/default.json`)으로 대체한다.
- 운영자가 수동 확인할 수 있도록 `docs/journal/`에 실패 내역을 요약한다.

**연관 컴포넌트**
- `src/services/welcome_handler.py` (신규), `scripts/manage_instances.ps1`, `config/templates/welcome/`, `docs/setup/iris-hyperv.md`.

### 3.3 방송 메시지
**목적**
- 운영자가 지정한 공지/콘텐츠를 다수의 방에 일괄 발송해 업무 효율을 높인다.

**트리거 & 전제조건**
- 운영 CLI 혹은 대시보드에서 방송 요청을 등록 (`broadcast.jsonl`).
- 방송 큐가 `data/broadcast_queue.sqlite` (예정)로 관리됨.
- 방 연결 상태 및 인증 토큰이 유효.

**주요 단계**
1. 운영자가 방송 요청을 등록하면 `src/services/broadcast_scheduler.py`가 큐에 저장한다.
2. 스케줄러가 1초 간격으로 큐를 확인하여 실행 가능한 작업을 꺼낸다.
3. 각 방에 대해 루팅 단말의 Iris API를 통해 메시지 전송 → 성공 여부를 수집한다.
4. 전체 완료 후 요약 리포트를 생성해 운영 알림 채널로 전송한다.

**산출물 / 로그**
- 방송 실행 로그 (`logs/broadcast/YYYY-MM-DD.log`).
- 성공/실패 통계 JSON (`artifacts/<timestamp>-broadcast/summary.json`).
- 실패 건 재시도 큐 (`data/broadcast_retry.json`).

**성공 기준**
- 요청 등록 후 1분 이내 첫 전송 시작.
- 전체 방송 성공률 99% 이상, 실패 건은 3회 재시도 후 경고.
- 방송 중 충돌(동일 방 중복 방송) 방지.

**실패 및 예외 대응**
- IRIS 응답 지연 시 백오프(1s, 2s, 4s) 적용 후 재시도.
- 방이 비활성화 상태인 경우 `docs/todo.md`에 운영 작업으로 기록.
- 스케줄러 중단 시 `scripts/manage_instances.ps1`를 통해 자동 재기동.

**연관 컴포넌트**
- `src/services/broadcast_scheduler.py` (신규), `data/broadcast_queue.sqlite`, `docs/ops/` (추가 예정), `scripts/manage_instances.ps1`.

## 4. 지원 시스템 및 데이터
- 루팅 안드로이드 단말 + IRIS 앱 + Hyper-V 리눅스 VM.
- 스토리지: 초기에는 파일/SQLite 기반, 확장 시 외부 DB로 전환.
- 외부 API: 환영 이미지/명령어 처리에 필요한 외부 서비스(Naver, Gemini 등) 토큰 관리.
- 모니터링: `docs/journal/`, SSOT, Slack/메일 알림 연동 예정.

## 5. 사용자 스토리
- 운영자는 링크 목록을 등록하고, 각 방의 상황·로그를 대시보드에서 확인할 수 있다.
- 운영자는 명령어 템플릿을 추가하여 즉시 기능을 확장할 수 있다.
- 신규 참여자는 자동으로 환영 멘트를 받고, 안내 이미지를 통해 규칙을 숙지한다.
- 운영자는 중요 공지를 한 번의 클릭으로 모든 방에 배포한다.

## 6. 범위
### 포함
- 루팅 단말 + IRIS 기반 이벤트 수집 및 전송.
- 명령어 라우팅/응답 모듈.
- 입장/퇴장 이벤트 핸들러.
- 방송 큐 관리 및 실패 리커버리.
- 로그/모니터링(텍스트 기반).
- 문서화 및 스크립트화된 배포 절차.

### 제외
- PC UIA/스크린샷 기반 자동화.
- 카카오 내부 비공개 API 직접 호출.
- 고급 대시보드 UI (초기 버전에서는 CLI/문서 중심).

## 7. 성공 지표
| 항목 | 목표 | 측정 방법 | 관련 기능 |
| --- | --- | --- | --- |
| 명령어 응답 시간 | 평균 3초 이내 | IRIS 이벤트 타임스탬프 비교 | 다중 방 추적/명령어 모듈 |
| 환영 메시지 누락 | 0건 | 이벤트 로그 대조 | 환영 및 안내 메시지 |
| 방송 성공률 | 99% 이상 | 방송 큐 처리 로그 | 방송 메시지 |
| 방별 로그 누락 | 0 | 일일 로그 검증 스크립트 | 다중 방 추적 |

## 8. 제약 사항
- 카카오 이용 약관 준수 필요. 계정/디바이스 제한을 고려한 운영 절차 마련.
- 루팅 단말·Iris 업데이트 시 테스트 환경에서 먼저 검증.
- 외부 API 키 관리 및 요금제 제한.

## 9. 문서 & 프로세스
- 단일 출처: `docs/ssot.md`
- 결정 사항: ADR 시리즈 (`docs/adr/`)
- 개발 로드맵: `docs/roadmap.md`
- 세션 로그: `docs/journal/`
- 실행 체크리스트: `agents.md`

## 10. 향후 확장
- 웹 대시보드/알림 시스템.
- 다중 인스턴스 오케스트레이션.
- 메시지 분석/리포팅 자동화.
- 운영자용 모바일 푸시 알림.
